# AgentsWorkflow macOS Application

This directory contains the main macOS application for the Agents Workflow project, which serves as a host for system extensions including the AgentFSKitExtension filesystem extension.

## Project Structure

```
AgentsWorkflow/
├── AgentsWorkflow.xcodeproj/          # Xcode project file
├── AgentsWorkflow/                    # Host application source code
│   ├── main.swift                     # Application entry point
│   ├── AppDelegate.swift              # Application delegate
│   ├── MainViewController.swift       # Main UI controller
│   ├── Info.plist                     # Application metadata
│   └── AgentsWorkflow.entitlements    # Code signing entitlements
├── PlugIns/                           # Embedded system extensions
│   └── AgentFSKitExtension.appex/     # FSKit filesystem extension
│       ├── AgentFSKitExtension.swift  # Extension main class
│       ├── AgentFsUnary.swift         # FSUnaryFileSystem implementation
│       ├── AgentFsVolume.swift        # Volume operations
│       ├── AgentFsItem.swift          # File/directory items
│       ├── AgentFSBridge.c            # C bridge functions
│       ├── AgentFSKitFFI.h            # FFI header
│       ├── Constants.swift            # Extension constants
│       ├── Info.plist                 # Extension metadata
│       └── AgentFSKitExtension.entitlements # Extension entitlements
├── libs/                              # Universal Rust libraries (generated)
├── build-universal.sh                 # Build script for universal binaries
└── README.md                          # This file
```

## Building the Project

### Prerequisites

- macOS 15.4+ with Xcode 15+
- Rust toolchain with targets: `aarch64-apple-darwin` and `x86_64-apple-darwin`
- `cbindgen` for generating C headers (optional)

### Building Universal Binaries

The project supports universal binaries for both Intel and Apple Silicon Macs. Use the provided build script:

```bash
./build-universal.sh
```

This script will:
1. Build all required Rust crates for both architectures
2. Create universal binaries using `lipo`
3. Generate C headers for FFI
4. Build the Xcode project

### Manual Xcode Build

You can also build directly with Xcode:

```bash
xcodebuild -project AgentsWorkflow.xcodeproj -scheme AgentsWorkflow -configuration Release build
```

## Code Signing and Entitlements

### Host Application Entitlements
- App Sandbox enabled
- Application group for shared data
- System extension install permission
- User-selected file access

### Extension Entitlements
- FSKit filesystem module entitlement
- App Sandbox enabled

## System Extension Registration

When the application launches, embedded system extensions are automatically registered with the system. To enable the extensions:

1. Launch the AgentsWorkflow application
2. Go to System Settings > General > Login Items & Extensions > File System Extensions
3. Enable the AgentFSKitExtension

## Testing

### Mount Testing

Once the extension is enabled, you can test mounting:

```bash
# Create a test device
mkfile -n 100m test.img
hdiutil attach -imagekey diskimage-class=CRawDiskImage -nomount test.img

# Mount using the extension
sudo mount -F -t AgentFS diskN /tmp/test-mount
```

### Development Mode

For development, you can temporarily disable code signing:
```bash
xcodebuild -project AgentsWorkflow.xcodeproj -scheme AgentsWorkflow build CODE_SIGNING_ALLOWED=NO
```

## Troubleshooting

### Extension Not Appearing
- Ensure the host app has been launched at least once
- Check System Settings > Privacy & Security for approval prompts
- Verify code signing and entitlements

### Build Failures
- Ensure all Rust targets are installed: `rustup target add aarch64-apple-darwin x86_64-apple-darwin`
- Check that universal libraries were built correctly
- Verify Xcode command line tools are installed

### Mount Failures
- Check Console.app for extension logs
- Ensure the extension is enabled in System Settings
- Verify the FSShortName matches the mount command

## Architecture Notes

- The host application uses standard macOS AppKit
- Extensions are embedded as PlugIns/ in the app bundle
- Rust libraries are linked as universal static libraries
- FFI bridging uses C headers generated by cbindgen

