# Copyright 2025 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

name: interactive_development_scenario
initialPrompt: "Let's work on implementing a user authentication system. I'll guide you through the requirements gathering, design, and implementation process."
repo:
  init: true
  files:
    - path: 'README.md'
      contents: |
        # User Authentication System

        This project needs a user authentication system.
timeline:
  # Initial requirements gathering
  - llmResponse:
      - think:
          - [
              1000,
              'Starting the authentication system implementation. I need to gather requirements from the user.',
            ]
      - assistant:
          - [
              500,
              "Let's start by gathering the requirements for your authentication system. What type of users will be using this system?",
            ]

  # First user input - user types
  - userInputs:
      - [
          1500,
          'What types of users will authenticate with this system? (e.g., customers, employees, admins)',
        ]
    target: 'tui'

  # Process user requirements
  - llmResponse:
      - think:
          - [
              800,
              'User specified their user types. Now I need to ask about authentication methods.',
            ]
      - assistant:
          - [
              400,
              'Great! Now, what authentication methods do you want to support? (password, email verification, social login, etc.)',
            ]

  # Second user input - authentication methods
  - userInputs:
      - [
          1500,
          'What authentication methods should we support? Please specify which ones are most important.',
        ]
    target: 'tui'

  # Design phase
  - llmResponse:
      - think:
          - [1000, 'Got the authentication methods. Now I need to design the database schema.']
      - assistant:
          - [
              600,
              "Now I'll start designing the system. Let me create the user model and database schema first.",
            ]
      - tool:
          - [2000, 'writeFile']
          - args:
              path: 'models.py'
              text: |
                # User authentication models
                from dataclasses import dataclass
                from typing import Optional
                from datetime import datetime

                @dataclass
                class User:
                    id: int
                    email: str
                    username: str
                    password_hash: str
                    created_at: datetime
                    last_login: Optional[datetime] = None
                    is_active: bool = True

  # Show the user the design
  - llmResponse:
      - think:
          - [
              500,
              'Created the basic user model. Now I should show it to the user and ask for feedback.',
            ]
      - assistant:
          - [
              400,
              "I've created a basic User model. Take a look at it and let me know if you want any changes.",
            ]

  # Third user input - model feedback
  - userInputs:
      - [
          2000,
          'Please review the User model I created. Do you want to add any additional fields or modify existing ones?',
        ]
    target: 'tui'

  # Implement authentication logic
  - llmResponse:
      - think:
          - [800, "User approved the model. Now I'll implement the authentication service."]
      - assistant:
          - [
              400,
              "Great! Now I'll implement the authentication service with login and registration functionality.",
            ]
      - tool:
          - [2500, 'writeFile']
          - args:
              path: 'auth_service.py'
              text: |
                # Authentication service
                import hashlib
                from typing import Optional
                from models import User

                class AuthService:
                    def __init__(self):
                        self.users = {}  # In-memory storage for demo

                    def hash_password(self, password: str) -> str:
                        return hashlib.sha256(password.encode()).hexdigest()

                    def register_user(self, email: str, username: str, password: str) -> User:
                        if email in [u.email for u in self.users.values()]:
                            raise ValueError("Email already registered")

                        user = User(
                            id=len(self.users) + 1,
                            email=email,
                            username=username,
                            password_hash=self.hash_password(password),
                            created_at=datetime.now()
                        )
                        self.users[user.id] = user
                        return user

                    def authenticate(self, email: str, password: str) -> Optional[User]:
                        for user in self.users.values():
                            if user.email == email and user.password_hash == self.hash_password(password):
                                user.last_login = datetime.now()
                                return user
                        return None

  # Test the implementation
  - llmResponse:
      - think:
          - [600, 'Implemented the auth service. Now I should test it.']
      - assistant:
          - [300, 'Let me create a simple test to verify the authentication works.']
      - tool:
          - [1500, 'writeFile']
          - args:
              path: 'test_auth.py'
              text: |
                # Test the authentication system
                from auth_service import AuthService

                def test_authentication():
                    auth = AuthService()

                    # Test registration
                    user = auth.register_user("test@example.com", "testuser", "password123")
                    print(f"Registered user: {user.username}")

                    # Test login
                    logged_in_user = auth.authenticate("test@example.com", "password123")
                    if logged_in_user:
                        print(f"Login successful for: {logged_in_user.username}")
                    else:
                        print("Login failed")

                    # Test wrong password
                    wrong_login = auth.authenticate("test@example.com", "wrongpassword")
                    if wrong_login:
                        print("ERROR: Wrong password should not work")
                    else:
                        print("Wrong password correctly rejected")

                if __name__ == "__main__":
                    test_authentication()

  # Run the test
  - llmResponse:
      - think:
          - [400, 'Created the test. Now let me run it to make sure everything works.']
      - assistant:
          - [200, 'Running the authentication test to verify everything works.']
      - tool:
          - [1000, 'runCmd']
          - args:
              command: 'cd /workspace && python test_auth.py'
              cwd: '.'
          - result: 'Test completed successfully'
          - status: 'ok'

  # Add password requirements
  - llmResponse:
      - think:
          - [700, 'Tests pass. Now I should add password strength requirements.']
      - assistant:
          - [
              400,
              "The basic authentication is working! Now let's add password strength validation. What password requirements do you want?",
            ]

  # Fourth user input - password requirements
  - userInputs:
      - [
          2000,
          'What password requirements should we enforce? (minimum length, special characters, etc.)',
        ]
    target: 'tui'

  # Implement password validation
  - llmResponse:
      - think:
          - [600, "Got password requirements. Now I'll implement the validation."]
      - assistant:
          - [300, "I'll add password validation to the registration process."]
      - tool:
          - [2000, 'writeFile']
          - args:
              path: 'password_validator.py'
              text: |
                # Password validation utilities
                import re

                class PasswordValidator:
                    @staticmethod
                    def validate_password(password: str) -> list:
                        errors = []

                        if len(password) < 8:
                            errors.append("Password must be at least 8 characters long")

                        if not re.search(r'[A-Z]', password):
                            errors.append("Password must contain at least one uppercase letter")

                        if not re.search(r'[a-z]', password):
                            errors.append("Password must contain at least one lowercase letter")

                        if not re.search(r'\d', password):
                            errors.append("Password must contain at least one number")

                        if not re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
                            errors.append("Password must contain at least one special character")

                        return errors

                    @staticmethod
                    def is_valid_password(password: str) -> bool:
                        return len(PasswordValidator.validate_password(password)) == 0

  # Update auth service to use validation
  - llmResponse:
      - think:
          - [500, 'Created password validator. Now I need to integrate it with the auth service.']
      - assistant:
          - [300, "Now I'll update the auth service to use the password validator."]
      - tool:
          - [1500, 'readFile']
          - args:
              path: 'auth_service.py'
          - result: 'File read successfully'
      - tool:
          - [2000, 'runCmd']
          - args:
              command: |
                cd /workspace && python -c "
                from auth_service import AuthService
                from password_validator import PasswordValidator

                # Test password validation
                print('Testing password validation...')
                weak_passwords = ['123', 'password', 'Password', 'Password1']
                strong_password = 'MySecurePass123!'

                for pwd in weak_passwords:
                    errors = PasswordValidator.validate_password(pwd)
                    print(f'Password \"{pwd}\": {\"VALID\" if not errors else \"INVALID - \" + \", \".join(errors)}')

                print(f'Strong password \"{strong_password}\": {\"VALID\" if PasswordValidator.is_valid_password(strong_password) else \"INVALID\"}')"

              cwd: '.'
          - result: 'Password validation test completed'
          - status: 'ok'

  # Add session management
  - llmResponse:
      - think:
          - [600, 'Password validation is working. Now I should add session management.']
      - assistant:
          - [
              400,
              "Great! Now let's add session management to keep users logged in. How long should sessions last?",
            ]

  # Fifth user input - session duration
  - userInputs:
      - [2000, 'How long should user sessions last? (e.g., 30 minutes, 2 hours, 1 day, etc.)']
    target: 'tui'

  # Implement session management
  - llmResponse:
      - think:
          - [500, "Got session duration preference. Now I'll implement session management."]
      - assistant:
          - [300, "I'll create a session manager that handles login sessions."]
      - tool:
          - [2500, 'writeFile']
          - args:
              path: 'session_manager.py'
              text: |
                # Session management
                import uuid
                from datetime import datetime, timedelta
                from typing import Dict, Optional
                from models import User

                class SessionManager:
                    def __init__(self, session_timeout_hours: int = 24):
                        self.sessions: Dict[str, dict] = {}
                        self.session_timeout = timedelta(hours=session_timeout_hours)

                    def create_session(self, user: User) -> str:
                        session_id = str(uuid.uuid4())
                        self.sessions[session_id] = {
                            'user_id': user.id,
                            'created_at': datetime.now(),
                            'expires_at': datetime.now() + self.session_timeout
                        }
                        return session_id

                    def validate_session(self, session_id: str) -> Optional[User]:
                        if session_id not in self.sessions:
                            return None

                        session = self.sessions[session_id]
                        if datetime.now() > session['expires_at']:
                            del self.sessions[session_id]
                            return None

                        # In a real app, you'd look up the user from database
                        # For demo, we'll return a mock user
                        return User(
                            id=session['user_id'],
                            email=f"user{session['user_id']}@example.com",
                            username=f"user{session['user_id']}",
                            password_hash="",
                            created_at=session['created_at']
                        )

                    def end_session(self, session_id: str):
                        if session_id in self.sessions:
                            del self.sessions[session_id]

  # Final integration
  - llmResponse:
      - think:
          - [
              700,
              'Session management is done. Now I should create a main application file that ties everything together.',
            ]
      - assistant:
          - [
              400,
              'Perfect! Now let me create a main application file that demonstrates the complete authentication system.',
            ]
      - tool:
          - [2000, 'writeFile']
          - args:
              path: 'main.py'
              text: |
                # Main authentication application
                from auth_service import AuthService
                from session_manager import SessionManager
                from password_validator import PasswordValidator

                def main():
                    auth_service = AuthService()
                    session_manager = SessionManager()

                    print("Welcome to the Authentication System Demo!")
                    print("=" * 50)

                    # Register a user
                    try:
                        user = auth_service.register_user(
                            "john@example.com",
                            "johndoe",
                            "SecurePass123!"
                        )
                        print(f"✓ Registered user: {user.username} ({user.email})")

                        # Create a session
                        session_id = session_manager.create_session(user)
                        print(f"✓ Created session: {session_id[:8]}...")

                        # Validate the session
                        validated_user = session_manager.validate_session(session_id)
                        if validated_user:
                            print(f"✓ Session validated for: {validated_user.username}")
                        else:
                            print("✗ Session validation failed")

                    except ValueError as e:
                        print(f"✗ Registration failed: {e}")

                    print("\\nAuthentication system demo completed!")

                if __name__ == "__main__":
                    main()

  # Run the final demo
  - llmResponse:
      - think:
          - [400, 'Created the main application. Let me run it to show the complete system.']
      - assistant:
          - [200, 'Let me run the complete authentication system demo.']
      - tool:
          - [1500, 'runCmd']
          - args:
              command: 'cd /workspace && python main.py'
              cwd: '.'
          - result: 'Demo completed successfully'
          - status: 'ok'

  # Final summary
  - llmResponse:
      - think:
          - [500, 'The authentication system is complete and working. Let me provide a summary.']
      - assistant:
          - [
              800,
              "Excellent! I've successfully implemented a complete user authentication system with user management, password validation, and session handling. The system includes proper error handling and security measures.",
            ]

expect:
  exitCode: 0
  artifacts:
    - type: 'taskFile'
      pattern: 'models.py'
    - type: 'taskFile'
      pattern: 'auth_service.py'
    - type: 'taskFile'
      pattern: 'password_validator.py'
    - type: 'taskFile'
      pattern: 'session_manager.py'
    - type: 'taskFile'
      pattern: 'main.py'
