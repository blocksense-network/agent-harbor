# Copyright 2025 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

name: snapshot_anchoring_precision
initialPrompt: Test snapshot anchoring precision
description: Test byte-level anchoring precision for filesystem snapshots in recordings
repo:
  init: true
timeline:
  - llmResponse:
      - think:
          - content: Testing precise snapshot anchoring with multiple operations.
            relativeTime: 100
  - agentToolUse:
      toolName: writeFile
      args:
        path: config.json
        text: "{\n  \"version\": \"1.0.0\",\n  \"name\": \"test-app\"\n}\n"
      result: Config created
      status: ok
  - llmResponse:
      - assistant:
          - content: First checkpoint - initial config.
            relativeTime: 50
  - agentToolUse:
      toolName: writeFile
      args:
        path: app.py
        text: "import json\n\ndef load_config():\n    with open('config.json') as f:\n\
          \        return json.load(f)\n"
      result: App created
      status: ok
  - llmResponse:
      - assistant:
          - content: Second checkpoint - app loader.
            relativeTime: 50
  - agentToolUse:
      toolName: appendFile
      args:
        path: config.json
        text: ",\n  \"port\": 8080\n"
      result: Port added
      status: ok
  - llmResponse:
      - assistant:
          - content: Third checkpoint - configuration updated.
            relativeTime: 50
  - agentToolUse:
      toolName: replaceInFile
      args:
        path: config.json
        old_str: '"version": "1.0.0"'
        new_str: '"version": "1.1.0"'
      result: Version bumped
      status: ok
  - llmResponse:
      - assistant:
          - content: Fourth checkpoint - version updated. Each snapshot should be anchored
              to precise byte offsets in the PTY stream.
            relativeTime: 50
expect:
  exitCode: 0
  artifacts:
    - type: taskFile
      pattern: config.json
    - type: taskFile
      pattern: app.py
  snapshots:
    count: 4
    anchor_validation: byte_offset_monotonic
    anchor_spacing_ms: '>= 50'
