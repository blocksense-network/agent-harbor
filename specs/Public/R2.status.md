# R2. Multi-Agent Draft Selectors ‚Äî Status

## Overview

Task **R2** from `specs/Public/First.Release.status.md` upgrades the TUI draft cards so operators can pick multiple agents/models per draft, adjust counts, and launch multi-agent tasks that stay in sync with the CLI, recorder, REST server, and persistence layers. This status file tracks the remaining work, following the conventions in `specs/AGENTS.md`: each milestone lists concrete deliverables plus fully automated verification. Completed milestones also include implementation notes, key source references, and outstanding follow-ups.

## Milestones

### M0. Multi-Select Modal Foundation (Complete)

**Deliverables**

- [x] Rich `ModalType::AgentSelection` state with `AgentSelectionViewModel { name, count, is_selected }`.
- [x] Keyboard and mouse controls for increment/decrement (`+/-`, Left/Right, scroll wheel, click targets) updated counts in-place.
- [x] Modal application logic stored full `Vec<AgentChoice { agent, model, count, settings }>` per draft card, ensuring launch paths receive accurate counts.
- [x] `TaskLaunchParams` + task managers (local + REST) honored multiple agents and replicated session IDs per instance.
- [x] Draft persistence serialized multi-agent selections to SQLite; recorder/REST wire-format already accepted `agents: [...]`.

**Implementation Details**

- The dashboard view-model (`crates/ah-tui/src/view_model/agents_selector_model.rs`) keeps per-modal option state, re-computes filtered options as the user types, and applies the resulting `AgentChoice` vector back into each draft card.
- Keyboard shortcuts are defined through `MODEL_SELECTION_MODE`, allowing deterministic testing of `ActivateCurrentItem`, `IncrementValue`, and `DecrementValue`.
- Launch paths reuse the same `AgentChoice` vector: the TUI hands counts to `TaskLaunchParams::builder().agents(..)`, `GenericLocalTaskManager` fans out sessions, and the REST manager serializes arrays of agents.
- Persistence paths (auto-save, manual save, mock REST client) reuse `AgentChoice` so drafts survive reloads, rehydrating modal state with the stored counts.

**Key Source Files**

- `crates/ah-tui/src/view_model/agents_selector_model.rs`
- `crates/ah-tui/src/view_model/task_entry.rs`
- `crates/ah-core/src/local_task_manager.rs`
- `crates/ah-rest-api-contract/src/types.rs`
- `crates/ah-tui/tests/prd_input_tests.rs`
- `crates/ah-tui/tests/model_viewmodel_tests.rs`

**Outstanding Tasks**

- Button text still shows only the first agent; pluralization (`"ü§ñ X agent(s)"`) is tracked under M3.
- Modal inventory now uses async loading with error states (completed in M1).
- Docs/config/manual flows must describe the new selector (M4/M5).

### M1. Agent Catalog & Enumerators (Complete)

**Deliverables**

- [x] Introduce `AgentCatalog` + `AgentsEnumerator` in `ah-core`, normalizing agent metadata from:
  - Local config (`.ah/config.toml`, repo overrides, default bundles)
  - REST `GET /api/v1/agents` (with cached TTL + error handling)
  - Mock data for offline mode/tests
- [x] Shared domain structs (`ah-domain-types`) expose experimental flags, display names, capabilities, and per-agent defaults (model, instance count, settings).
- [x] TUI, CLI, and REST clients depend on the enumerator instead of hardcoded lists.
- [x] `ah-cli`/`ah-config-types` gain `default_agents` + `experimental_agents` settings with precedence resolution (env, repo config, user config).
- [x] `--experimental-features <set>` CLI/config flag gates experimental catalog entries and surfaces friendly warnings when disabled.

**Implementation Details**

- The `AgentCatalogProvider` trait defines the interface for fetching agent catalogs, implemented by `LocalAgentCatalog` and `RemoteAgentCatalog`. Both catalog types implement `AgentsEnumerator` directly, eliminating the need for a wrapper `ProductionAgentsEnumerator`.
- Local catalog discovers agents via `AgentBinary` objects (caching executable paths), filters by experimental features, and creates metadata for each discovered model with appropriate display names (e.g., "Claude Sonnet", "Codex (Optimized)").
- Remote catalog fetches from REST API with caching, retry logic, and fallback to default catalog. Remote mode trusts server-side experimental filtering; local mode applies client-side filtering.
- Experimental features are defined in `ExperimentalFeature` enum (gemini, copilot, cursor-cli, goose) and controlled via `--experimental-features` CLI flag, with Copilot, Gemini, Cursor CLI, and Goose marked as experimental by default.
- TUI ViewModel now uses async loading with `AgentsEnumerator` instead of hardcoded agent lists, enabling dynamic catalog updates and error handling.
- Mock dashboard uses `LocalAgentCatalog` directly for testing, with all experimental features enabled by default.

**Key Source Files**

- `crates/ah-core/src/agent_catalog.rs` - Core catalog implementation, enumerators, and providers
- `crates/ah-domain-types/src/agent.rs` - Agent metadata structs and experimental flag handling
- `crates/ah-domain-types/src/experimental_features.rs` - ExperimentalFeature enum definition
- `crates/ah-cli/src/lib.rs` - CLI argument parsing for experimental features
- `crates/ah-cli/src/tui.rs` - TUI dependencies integration with enumerators
- `crates/ah-tui/src/view_model/agents_selector_model.rs` - Async agent loading in ViewModel
- `crates/ah-core/tests/agent_catalog_tests.rs` - Unit tests for catalog functionality

**Verification (automated)**

- [x] `ah-core` unit tests cover catalog merging, deduplication, experimental gating, and REST fallback behavior.
- [x] `ah-cli` config tests ensure precedence (env > repo > user > defaults) and `--experimental-features` parsing.
- [x] TUI unit tests mock the enumerator to assert loading/error states propagate to the view-model (`loading_agents`, `agent_errors`).
- [x] REST contract tests simulate `GET /api/v1/agents` responses (success, transient failure, empty) and ensure enumerator retries obey exponential backoff and TTL invalidation.

**Outstanding Tasks**

- M2 depends on M1 completion for async loading implementation
- Experimental feature precedence resolution could be enhanced with config file support
- REST fallback behavior could be improved with more sophisticated error handling

### M2. Asynchronous Loading & UI States

**Deliverables**

- [ ] Refactor `ViewModel::new_internal` to start with empty agent lists and trigger async load via enumerator, populating modal options when ready.
- [ ] Surface `loading_agents` / `agents_error` states in the draft cards (button text + footer) and within the modal (skeleton rows, retry prompts).
- [ ] Implement refresh triggers (Ctrl+R, context menu, config watcher) so operators can re-sync catalog entries without restarting.
- [ ] Persist last-used agent selections in `ah-local-db::kv` with repository/user scopes, seeded by enumerator defaults when catalog loads later.

**Verification (automated)**

- [ ] TUI ViewModel tests simulate enumerator futures resolving success/failure and assert UI transitions (loading ‚Üí success, loading ‚Üí error ‚Üí retry).
- [ ] Integration tests for persistence ensure saved drafts reload correctly even when catalog data arrives after drafts are rendered.
- [ ] Scenario tests (goldens) record the modal states for ‚Äúloading‚Äù, ‚Äúempty catalog‚Äù, ‚Äúerror with retry‚Äù.

### M3. UX & Launch Polish

**Deliverables**

- [ ] Update draft card button text to show `"ü§ñ X agent(s)"`, with tooltip listing the top selections.
- [ ] Modal footer hints adapt to count states (e.g., ‚ÄúEnter Keep Selections ‚Ä¢ +/- Adjust Count ‚Ä¢ Esc Cancel‚Äù).
- [ ] Implement contextual validation: disable ‚ÄúGo‚Äù when selections are empty or exceed configurable per-task limits; show error banners with actionable guidance.
- [ ] Add `AgentSelectorState` to local DB so reopened drafts preserve per-agent count ordering and ‚Äúlast adjusted‚Äù metadata.
- [ ] Provide accessible focus order + screen reader labels for the modal controls (counts, increment/decrement buttons).

**Verification (automated)**

- [ ] Golden TUI screenshots (scenario runner) capturing button text, tooltips, and footer hints for 1 agent vs. multi-agent counts.
- [ ] Accessibility-focused tests asserting focus order and ARIA-style labels (ratatui event harness).
- [ ] Draft validation tests ensure zero-agent launches are blocked with deterministic status messages.

### M4. Config, Docs, & CLI Alignment

**Deliverables**

- [ ] Document `default_agents`, `experimental_agents`, and `--experimental-features` in `specs/Public/CLI.md` (new CLI help block), `specs/Public/TUI-PRD.md`, and `specs/Public/Configuration.md`.
- [ ] Extend `ah-cli` (`ah task`, `ah agent start`, `ah agent record`) to reuse the catalog and surface the same warning/error states (missing agents, experimental disabled).
- [ ] Provide `just manual-test-tui-multi-agent` that boots the TUI with mock catalog data, scripted prompts covering multi-agent selection, and log capture (`manual-tests/logs/`).
- [ ] Update `REST-Service/API.md` to explicitly map `TaskLaunchParams.agents()` to `CreateTaskRequest.agents[]`, including experimental gating semantics.

**Verification (automated)**

- [ ] CLI snapshot tests covering `ah task --help` and `ah agent start --help` show new options.
- [ ] Doc lint ensures added sections pass `just lint-specs` (markdown, link, spell, mermaid).
- [ ] Manual test script smoke test (`just test-manual-multi-agent-scenario`) launches the scripted flow headlessly and verifies log output + exit codes.

### M5. End-to-End Scenarios & Regression Coverage

**Deliverables**

- [ ] Scenario-format fixtures under `tests/tools/mock-tui-dashboard/scenarios/multi_agent/*.yaml` that:
  - Load catalog data (including experimental entries) via mocked enumerator.
  - Walk keyboard/mouse paths (multi-select, count adjustments, removal, reload).
  - Launch multi-agent drafts and assert `TaskLaunchParams` contents.
- [ ] `ah-core` integration tests verifying:
  - `TaskLaunchParams::build` rejects zero agents or out-of-range counts.
  - Local and REST managers emit correct session counts/logs for varied agent mixes.
- [ ] REST contract tests ensure `session_ids.len() == sum(count)` and failure cases (unknown agent, experimental disabled).
- [ ] Regression suite for footer pluralization, button states, and enumerator retries hooked into `just test-tui`.

**Verification (automated)**

- [ ] Scenario runner golden outputs (Linux + macOS terminal sizes) stored under `crates/ah-tui/tests/__goldens__/multi_agent_*`.
- [ ] `cargo nextest run -p ah-core --test task_launch_multi_agent` covering validation edge cases.
- [ ] REST mock client tests verifying serialization/deserialization plus error mapping.
- [ ] CI pipeline step (`just test-multi-agent-selectors`) that orchestrates all relevant unit, integration, and scenario tests on Linux + macOS.
