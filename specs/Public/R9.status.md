# R9. Command Output Capture — Status

## Overview

Task **R9** from `specs/Public/First.Release.status.md` requires us to surface every shell/tool command executed by a recorded agent session so that the recorder, REST APIs, CLI, and TUI can show a searchable command log for debugging. The workflow must stay lossless with `.ahr` replays (`specs/Public/ah-agent-record.md`) and operate in real time over SSE. We will satisfy the spec by:

- Injecting a **cross-platform interpose shim** (macOS via `DYLD_INSERT_LIBRARIES`, Linux via `LD_PRELOAD`) inspired by `crates/agentfs-interpose-shim` to observe process launches and stdout/stderr writes, even when file descriptors are duplicated or inherited.
- Extending the recorder pipeline (`ah-recorder`) with new record variants so `.ahr` captures command metadata and output chunks alongside PTY bytes.
- Persisting command events in `ah-local-db` / REST and rendering them inside the TUI/WebUI while exposing a CLI report (`ah session commands <id>`).

This document breaks the implementation into milestones with explicit deliverables and automated verification, following the conventions in `specs/AGENTS.md`. The shim itself must follow a **layered architecture**:

- `crates/ah-command-trace-shim/src/lib.rs` hosts a cross-platform core (FD table, IPC client, record builders) written in portable Rust with no `#[cfg]` outside well-scoped feature gates.
- Platform-specific adapters live under `src/platform/macos.rs`, `src/platform/linux.rs`, etc., containing only the symbol interposition and OS bindings required for that platform.
- Shared tests target the core layer; adapter-specific tests reside beside each module to keep OS APIs isolated.

Explicit layering keeps the shim maintainable as additional platforms (Windows hook DLL, BSD variants) join later without duplicating tracing logic.

**Test Harness Structure:** mirroring `crates/agentfs-interpose-e2e-tests`, the new shim must ship with a dedicated `crates/ah-command-trace-e2e-tests` crate. Running end-to-end tests from a _separate_ crate prevents the shim from being injected into `cargo test`’s runner binary (which would otherwise inherit our `DYLD_INSERT_LIBRARIES`/`LD_PRELOAD` settings and cause re-entrancy bugs). The e2e crate owns:

- `src/lib.rs`: helpers that locate the freshly built shim `.dylib/.so`, set up Unix sockets, and expose ergonomic `ShimRunner` utilities.
- `src/bin/test_helper.rs`: the small C/Rust programs we launch under the shim (spawn tree generator, stdout/stderr torture tool, etc.).
- Platform folders (`src/macos/tests.rs`, `src/linux/tests.rs`) that hold integration tests executed via `cargo test -p ah-command-trace-e2e-tests`.
- `build.rs`: copies/strips the shim artifact into a predictable path for the helper binaries and ensures signing on macOS if required.

Core unit tests (`cargo test -p ah-command-trace-shim`) stay pure Rust without LD_PRELOAD side effects, while `cargo test -p ah-command-trace-e2e-tests` exercises the real interposed environment.

## Interfaces & Dependencies

- `specs/Public/ah-agent-record.md`: governs `.ahr` format, recorder IPC, SSE stream, and vt100 pipeline that must consume the new events.
- `crates/agentfs-interpose-shim`: reference for environment-variable gated interpose loading, handshake, and safety checks; the new shim will reuse its patterns but target process exec + FD tracing rather than AgentFS handles.
- `ah-domain-types`, `ah-recorder`, `ah-cli`, `ah-tui`, `ah-rest-*`, `ah-local-db`: all gain new enums/records for `TaskEvent::Command`.
- Existing SSE and IPC channels (`--events-pipe-fd`, recorder IPC socket) must accept command events without breaking compatibility. Shim <-> recorder coordination happens over a dedicated Unix socket whose path is injected via recorder managed env vars (e.g., `AH_COMMAND_TRACE_SOCKET`).

## Milestones

### M0. Shim Bootstrap & Injection Smoke Tests

**Deliverables**

- [ ] Scaffold `crates/ah-command-trace-shim` with shared core + platform modules (macOS `.dylib`, Linux `.so`) and build-time gating (`cargo cfg` ensures no-std symbols are resolved before tests run).
- [ ] Provide ergonomic loaders for tests:
  - macOS: wrapper around `/usr/bin/env DYLD_INSERT_LIBRARIES=…` that spawns arbitrary binaries while guaranteeing SIP-safe environment variables.
  - Linux: helper that wraps commands with `LD_PRELOAD`, handles musl/glibc differences, and skips static binaries gracefully.
- [ ] Add `tests/shim_injection_smoke.rs` integration suite:
  - Launches a trivial helper binary (`tests/helpers/print_pid.rs`) via both loaders.
  - Asserts the shim announces itself over a loopback Unix socket (handshake + keepalive) before the helper writes a single byte.
  - Verifies the shim tears down cleanly even when the target immediately exits or calls `_exit`.
- [ ] Document loader environment variables (`AH_CMDTRACE_ENABLED`, `AH_CMDTRACE_SOCKET`, `AH_CMDTRACE_LOG`) and safe defaults (disabled when socket unset).

**Verification**

- [ ] `cargo test -p ah-command-trace-shim shim_injection_smoke` runs on macOS + Linux CI lanes.
- [ ] Negative test ensures shim stays dormant when `AH_CMDTRACE_ENABLED=0`.
- [ ] Sanitizer builds (ASAN/TSAN) run weekly to catch unsafe init ordering issues (esp. before `main()`).

### M1. Sub-Process Detection Harness

**Deliverables**

- [ ] Helper binary (`tests/helpers/spawn_tree.rs`) that:
  1. Launches two child processes (short-lived `true`, longer `sleep 0.1`).
  2. Spawns a nested grandchild via `posix_spawnp` or `execve` after `fork`.
  3. Uses `clone(CLONE_VM | CLONE_VFORK)` in Linux build to emulate lightweight shells.
- [ ] Extend shim to intercept:
  - `fork`, `vfork`, `clone`, `posix_spawn`, `exec*` family, and `posix_spawn_file_actions_adddup2`.
  - Provide deterministic `CommandStart` IPC frames (PID, PPID, argv, env snapshot hash, cwd, timestamp, exec path resolution).
- [ ] Add test `shim_records_spawn_tree`:
  - Runs helper with shim, captures IPC transcript, and asserts the exact structure (start/exec events for parent, children, grandchildren) and ordering (monotonic timestamps).
  - Validates edge cases: `execve` failure surfaces error payload, repeated `fork`+`_exit` does not emit spurious commands.
- [ ] Document handling for short-lived commands, zombies, reparenting, and setuid binaries (shim must skip injection when `AT_SECURE` is set).

**Verification**

- [ ] Snapshot tests comparing captured IPC JSON (normalized by removing timestamps) against expected spawn tree layouts.
- [ ] Stress test: helper loops 200 times creating burst of sub-processes; shim must report all without socket backpressure errors.
- [ ] Coverage for both dynamic shells (`/bin/sh`) and direct exec of binaries with custom interpreters (`/usr/bin/env python`).

### M2. Stdout/Stderr Chunk Capture

**Deliverables**

- [ ] Helper program (`tests/helpers/mixed_output.rs`) that:
  - Writes alternating stdout/stderr chunks of varying sizes (1 byte, 4 KiB, 128 KiB) using `write`, `writev`, and `sendmsg`.
  - Duplicates stdout via `dup2` into FD 7, writes via that FD, then closes original FDs to ensure shim tracks re-mapped descriptors.
  - Emits ANSI control codes, partial UTF-8 sequences, and binary data to ensure byte-perfect capture.
- [ ] Extend shim FD tracker:
  - Observe `dup`, `dup2`, `dup3`, `fcntl(F_DUPFD*)`, `close`, `pipe(2)`, `socketpair`, `openpty`, `posix_openpt`, `isatty`.
  - Track `O_CLOEXEC` propagation and lazy resolution of `/proc/self/fd`.
  - Attribute writes to the owning command ID, capturing PTY byte offsets when available.
- [ ] IPC protocol now includes `CommandChunk` messages with `stream` (`stdout`/`stderr`), `sequence_no`, byte payload, and optional `pty_offset`.
- [ ] Tests asserting:
  - All stdout/stderr segments arrive in emission order, even when interleaved or written via non-standard descriptors.
  - Non-blocking writes (set via `fcntl(O_NONBLOCK)`) are handled without busy loops.
  - Large bursts are chunked and flagged when truncation limits are hit (with `truncated=true` metadata).

**Verification**

- [ ] Integration tests verifying binary diff of captured chunk payloads vs. expected fixture.
- [ ] Edge-case tests:
  - Background threads writing simultaneously to stdout/stderr.
  - Writes after `fork` but before `exec` (should still attribute to parent command, not phantom command).
  - Programs reassigning stderr to a file; shim should stop capturing once FD no longer points to PTY.

### M3. Mock-Agent & Recorder End-to-End Scenario

**Deliverables**

- [ ] Wire shim IPC server into `ah agent record` so the recorder launches user commands with shim env vars, supervises socket lifecycle, and assigns session-scoped command IDs.
- [ ] Create deterministic Scenario-Format fixtures (e.g., `tests/tools/mock-agent/scenarios/command_log_smoke.yaml`) instructing the mock agent to:
  - Run multiple tools (`runCmd`, `grep`, `python`, long-running `bash` loops) with known outputs and nested subprocesses.
  - Exercise atypical behaviors: commands piping into others, background jobs (`runCmd` with `run_in_background: true`), quick failures (non-zero exit), and commands generating >1 MiB output.
- [ ] Add integration test `tests/recorder/command_trace_scenario.rs` that:
  1. Runs `ah agent record --mock-agent scenario.yaml --out-file trace.ahr`.
  2. Replays the resulting `.ahr`.
  3. Performs structural diff (ignore timestamps) verifying `REC_CMD_*` records interleave with PTY data as specified.
  4. Confirms SSE event stream (`--events-pipe-fd`) emits matching `command` events in real time.
- [ ] Provide helper for scenario assertions that inspects `.ahr` blocks:
  - Validates chunk ordering, byte offsets, and snapshot associations for commands overlapping with `ah agent fs snapshot` events.
- [ ] Document reproducible manual workflow (`just manual-test-command-log-scenario`) that runs the same scenario and prints parsed command logs.

**Verification**

- [ ] Golden fixtures of parsed `.ahr` metadata (JSON) stored under `tests/golden/command_trace/`.
- [ ] Replay smoke test ensures toggling `--command-trace=off` yields legacy `.ahr` (no new records) and passes back-compat.
- [ ] Scenario variant where the mock agent purposely kills a command mid-output; shim/recorder must emit `CommandEnd` with `exit_code=-1` and flag incomplete chunks.
- [ ] Scenario variant stressing multiple concurrent tools (multi-model agents) to ensure per-task isolation.

### M4. Telemetry Contract & `.ahr` Schema Alignment

**Deliverables**

- [ ] Define a canonical `CommandEvent` structure in `ah-domain-types::task` (fields: `command_id`, timestamps, argv/env snapshot, cwd, exit code, stream chunks annotated with `stdout`/`stderr`, truncated/dropped flags).
- [ ] Extend `specs/Public/ah-agent-record.md` with new record tags (`REC_CMD_START`, `REC_CMD_CHUNK`, `REC_CMD_END`) and describe how they interleave with PTY streams for deterministic replay.
- [ ] Update `ah-recorder::format` and `ah-recorder::events` to serialize/deserialize the new records, keeping block headers backward compatible (increment schema version, add feature flag negotiation).
- [ ] Expand SSE and unnamed-pipe event schemas so downstream listeners receive `{"type":"command","phase":"start|chunk|end",...}` payloads without needing `.ahr` parsing.
- [ ] Document recorder ↔ shim IPC contract (Unix socket message schema, flow control, reconnect behavior) inside this status file and `ah-recorder` rustdoc.

**Verification**

- [ ] Snapshot/unit tests in `ah-domain-types`, `ah-recorder`, and `ah-rest-api-contract` proving round-trip (serde + SSZ) fidelity for every new struct/enum combination.
- [ ] `.ahr` golden tests (new fixtures under `tests/data/ahr/`) verifying that mixed PTY + command records replay identically to the legacy format when command tracing is disabled.
- [ ] Back-compat test that replays an old `.ahr` (without command records) to ensure the new parser tolerates missing sections.

### M5. Cross-Platform Command Trace Shim (macOS + Linux)

**Deliverables**

- [ ] New crate `crates/ah-command-trace-shim` providing shared logic plus `#[cfg(target_os = "macos")]` and `#[cfg(target_os = "linux")]` adapters.
- [ ] macOS loader: signed `.dylib` injected via `DYLD_INSERT_LIBRARIES`, mirroring `agentfs-interpose-shim` environment guards (`AH_CMDTRACE_ENABLED`, socket path, allowlist, verbose logging).
- [ ] Linux loader: `.so` preloaded with `LD_PRELOAD`, supporting glibc and musl; disable itself when incompatible runtimes are detected (e.g., statically linked binaries).
- [ ] Interpose list (documented + implemented):
  - Process creation: `posix_spawn`, `posix_spawnp`, `fork`, `vfork`, `clone`, `execve`, `execv`, `execvp`, `execvpe`, `execveat`, `posix_spawn_file_actions_adddup2`.
  - Stdout/stderr writes: `write`, `writev`, `pwrite`, `pwritev`, `send`, `sendmsg`, `sendfile`, `splice`, `tee`.
  - FD lifecycle helpers: `dup`, `dup2`, `dup3`, `close`, `fcntl(F_DUPFD|F_DUPFD_CLOEXEC)`, `pipe`, `pipe2`, `socketpair`, `openpty`.
- [ ] Shim runtime that maintains an internal FD table to follow inherited descriptors across `dup*`/`close` so stdout/stderr clones are always recognized.
- [ ] IPC client sending compact binary frames (`CommandStart`, `CommandOutput`, `CommandExit`) to the recorder socket with retry/backoff and per-process buffering when the recorder restarts mid-session.
- [ ] Safety tooling: `just test-command-trace-shim` harness that launches a helper binary under both `DYLD_INSERT_LIBRARIES` and `LD_PRELOAD`, asserting the shim captures commands and recovers from recursive execs.

**Verification**

- [ ] macOS integration test: spawn `/bin/sh -c "echo hi && >&2 echo bye"` under the shim, assert the IPC stream produces the expected start/chunk/end messages with distinct stdout/stderr markers.
- [ ] Linux integration test: run binaries that duplicate stdout via `dup2(fd, 1)` and ensure chunks are still attributed to the right command ID.
- [ ] Stress test that launches >100 short-lived commands per second to validate the shim's buffering and backpressure (no dropped events, bounded memory).
- [ ] Static analyzer / `cargo clippy --tests` and `cargo fmt` gating the new crate on both platforms.

### M6. Recorder Ingestion, PTY Correlation, and Heuristics

**Deliverables**

- [ ] Recorder-side IPC server (Tokio Unix socket) that authenticates shim clients, assigns session-scoped command IDs, and merges shim frames into the recorder's ordered event queue before vt100 processing (`specs/Public/ah-agent-record.md`, section 4).
- [ ] Correlate command streams with PTY output so replay can highlight the same byte ranges that the shim captured (store PTY byte offsets in every command chunk).
- [ ] Heuristic fallback for agents where the shim cannot load (e.g., Windows remote tasks): extend vt100 analyzer to detect shell prompts (`$`, `>_`, `PS1` markers) and infer commands albeit flagged as `source: "heuristic"` for UI transparency.
- [ ] `ah-recorder` telemetry + logging documenting when the shim is connected, disconnected, or running in heuristic mode; expose status via SSE (`type: "command_tracer_status"`).
- [ ] Config flags: CLI options and config keys to disable command tracing, redact arguments, or cap output bytes per command for privacy-sensitive environments.

**Verification**

- [ ] End-to-end regression test under `tests/recorder/command_tracing.rs` that runs the mock agent, forces a snapshot, and checks that `.ahr` replay reproduces the command list with aligned PTY offsets.
- [ ] Unit tests for heuristic detector (deterministic fixtures with prompts, multi-line commands, commands in progress).
- [ ] SSE snapshot test verifying the new status events and command events flow through the unnamed pipe and REST SSE streams.

### M7. Persistence & API Propagation

**Deliverables**

- [ ] Extend `ah-local-db` schema (`state_persistence` plan) with `command_events` and `command_chunks` tables keyed by session + command ID, storing metadata + chunk hashes for deduplication.
- [ ] Update `ah-rest-api-contract` + `ah-rest-server` to expose:
  - `GET /api/v1/sessions/{id}/commands` (paged, filter by status, substring search).
  - SSE event type `command` for live updates.
- [ ] Add `ah-rest-client` helpers and TUI/WebUI data sources that keep an in-memory ring buffer of recent commands per task.
- [ ] CLI plumbing:
  - `ah session commands <session-id> [--follow] [--format text|json]`.
  - `ah agent record --command-log-limit <bytes>` to tune retention.
- [ ] Ensure `ah-domain-types` enumerations share between recorder, REST, CLI, and DB (no duplicate enums), aligning with R25 guidance.

**Verification**

- [ ] Database migration conformance test verifying schema matches `specs/Public/State-Persistence.md` updates and that reset scripts handle the new tables.
- [ ] REST contract tests (OpenAPI snapshot or `just test-rest`) confirming serialization parity and pagination behavior.
- [ ] CLI snapshot tests for `ah session commands` output (text + JSON) using deterministic fixtures.

### M8. UI Surfaces & Manual Workflows

**Deliverables**

- [ ] TUI: command log drawer per task card (collapsible pane) showing status, duration, stdout/stderr preview, filters (text, exit code, tool ID), copy-to-clipboard, search, and `Enter` to expand full output. Integrate with keyboard/mouse contracts from `specs/Public/TUI-PRD.md`.
- [ ] TUI auto-highlighting of command output in the recorder viewport (link command selection to PTY lines and timeline snapshots from `ah-agent-record.md`).
- [ ] WebUI parity (if applicable) or a stub status documenting the follow-up work if WebUI is outside this release scope.
- [ ] Manual validation recipes:
  - `just manual-test-command-log` to start a mock agent, run canonical commands, and open the command drawer.
  - Instructions in `docs/Component-Architecture.md` describing how to troubleshoot missing command events (shim disabled, heuristics fallback, SSE issues).

**Verification**

- [ ] Golden TUI tests under `crates/ah-tui/tests/command_log_scenarios.rs` capturing the drawer UI at various widths + with filtered results.
- [ ] Scenario test ensuring selecting a command scrolls the recorder viewport to the corresponding PTY byte offset.
- [ ] Manual test checklist stored in `manual-tests/command-log.md`, referenced by CI artifact when `just manual-test-command-log` runs successfully.

### M9. Reliability, Performance, and Security Hardening

**Deliverables**

- [ ] Metrics: extend recorder stats and SSE to report shim attach rate, buffered bytes, dropped events, and processing latency.
- [ ] Backpressure + retention policy (bounded buffer per session, fail-open strategy that degrades to heuristic mode rather than blocking agent output).
- [ ] Privacy controls: redact env vars/arguments marked sensitive (config + allowlists), pluggable scrubbing hooks for enterprise deployments.
- [ ] Profiling + optimization:
  - micro-benchmarks comparing pass-through latency with/without shim to ensure R12 targets stay intact (<200 ms).
  - `criterion` benchmarks for IPC merge path.
- [ ] Security review (docs) explaining how the shim avoids code injection outside recorder sessions, how sockets are secured (permissions, auth tokens), and how to disable tracing in restricted environments.

**Verification**

- [ ] Stress suite (e.g., `just test-command-log-stress`) generating 10k commands with 100 MiB combined output; asserts no data loss and bounded memory.
- [ ] Benchmark CI job capturing latency percentiles before/after enabling the shim; fails if regression >10%.
- [ ] Static analysis / sanitizers (ASAN/TSAN) run on shim crate nightly to catch unsafe-code regressions.

## Outstanding Questions / Risks

1. **Windows parity:** R9 scope focuses on macOS + Linux (per user guidance). We will document Windows gaps and insert a follow-up milestone once AgentFS interpose patterns on Windows are mature.
2. **Third-party agents inside containers:** Need to confirm whether remote executors (SSH, Docker) can load the shim; fallback heuristics may be the only option there.
3. **Redaction requirements:** Some customers may forbid capturing raw command arguments. Config UX must make redaction defaults explicit and auditable.

These open items will be refined as M1 concludes; any new constraints will be recorded here before implementation proceeds.
