# R15 — Implement `ah task` CLI spec (minus browser automation)

## Overview

- Objective: Replace the legacy Ruby task flow with a native Rust implementation that matches the `specs/Public/CLI.md` Task section and the R15 deliverables in `First.Release.status.md`, while explicitly excluding browser automation.
- Scope: CLI parsing, config precedence, prompt collection, branch creation/follow-ups, delivery flows, workspace/snapshot selection, fleet and multi-agent launches, notifications, and monitoring hand-off via `--follow`. Must reuse shared helpers in `crates/ah-cli` and `ah-core` so `.agents/tasks` files, metadata commits, and repo sanity checks are produced as specified.
- Dependencies: `crates/ah-cli/src/task.rs`, `crates/ah-cli/src/config.rs`, `crates/ah-core::{local_task_manager,TaskManager,AgentTasks}`, `ah-fs-snapshots`, `prepare_workspace_with_fallback`, mock-agent scenarios, and CLI docs (`specs/Public/CLI.md`).
- Non-goals: Browser automation and cloud-agent job submission remain stubbed with clear messaging; no new automation is added in this milestone.

## Milestones

### M1. CLI surface + config precedence foundation

**Deliverables**

- Align the `ah task` Clap definition with the spec (all flags, aliases, defaults, exit code 10 rules) and ensure `--json`, `--non-interactive`, and `--help` outputs match the documented synopsis and options.
- Consolidate configuration precedence using the helpers in `crates/ah-cli/src/config.rs` and `config_core`, covering system/user/repo/repo-user/env/flag layering and legacy compat env vars. Emit per-field provenance when `--show-origin` is used.
- Normalize agent selection arguments into reusable structs (agents/models/instances) reused by both CLI parsing and task launch parameters.
- Harden error surfaces: invalid combinations (e.g., `--follow` without repo in non-interactive), unknown agents, missing repo/workspace in `--non-interactive`, and unsupported flags when browser automation is disabled.

**Verification**

- [ ] Unit tests for configuration merging and precedence (system/user/repo/repo-user/env/flags) plus provenance reporting.
- [x] CLI parsing/unit tests covering agent/model/instances accumulation, default agent handling, and `--non-interactive` exit 10 cases.
- [ ] Help/JSON snapshot tests to lock the updated flag set (`cargo test -p ah-cli --test cli_help_snapshots` extension).

### M2. Prompt intake, branch protection, and task record creation

**Deliverables**

- Implement prompt collection paths: `--prompt`, `--prompt-file`, and interactive editor with template/comment stripping (respect `core.commentString` when configured and `task-template` file resolution). Abort cleanly on empty content.
- Enforce branch requirements from the spec: regex validation, primary branch protection, feature branching from current agent branches, and follow-up detection when already on an agent branch.
- Implement `.agents/tasks` file creation/appends with correct path format, follow-up separator, UTC timestamping, and metadata commit content (`Start-Agent-Branch`, `Target-Remote`, `Dev-Shell`). Honor `--create-task-files` and `--create-metadata-commits` semantics and roll back branch creation on failure.
- Implement devshell validation against `flake.nix` and push prompts (`--push-to-remote`, `--yes`, non-interactive exit 10). Ensure branch cleanup on any pre-execution failure.

**Verification**

- [ ] Unit tests for prompt processing (template stripping, comment handling, empty detection) and branch validation (regex, primary protection, follow-up detection).
- [ ] Tests for metadata commit generation and `.agents/tasks` path/content (including follow-up delimiter, dev-shell line, remote discovery).
- [ ] Scenario tests under `tests/tools/mock-agent/scenarios/` covering new task creation vs. follow-up, `--create-task-files` toggles, and push prompt behaviors.

### M3. Execution planning, workspace selection, and multi-agent/fleet orchestration

**Deliverables**

- Route working-copy and snapshot selection through `prepare_workspace_with_fallback`, persisting chosen provider/mode in local state; reuse `ah-core` helpers for repo sanity checks before launch.
- Wire `ah task` to `TaskManager`/`AgentTasks`/`local_task_manager` so session metadata, `.agents/tasks` updates, and commits happen in one code path for local and remote runs. Guard cloud-agent/browser-automation paths with explicit “disabled this release” messaging.
- Expand agent launch planning to honor multiple `--agent` entries, per-agent models/instances, fleet expansion (`--fleet`), sandbox/devcontainer selection, notifications flag propagation, and repo/workspace selection for remote mode.
- Ensure `--follow` launches the configured UI (TUI/WebUI) focused on the new task/session and propagates session metadata for monitoring.

**Verification**

- [ ] Integration tests that drive `ah task` through local and remote code paths, asserting workspace selection records, task state persistence, `.agents/tasks` updates, and metadata commits.
- [ ] Scenario tests for multi-agent and multi-instance launches plus fleet orchestration (local leader + remote member stubs) with mock agent recordings.
- [ ] Regression test ensuring cloud-agent/browser automation flags are rejected with clear messaging.
- [ ] Integration test that `--follow` opens the correct monitoring UI and attaches to the new session/task ID.

### M4. Delivery paths, push behavior, and branch/file safety

**Deliverables**

- Implement delivery options (`--delivery pr|branch|patch`, `--target-branch`) with the correct push gating, metadata collection, and task file/commit handling per spec. Integrate with `PushHandler` and repo URL detection for branch/PR metadata.
- Enforce repo sanity checks: clean working tree requirements when task files/commits are created, validation of remote availability for push flows, and cleanup on failed push/commit.
- Emit OS notifications per `--notifications` and ensure monitoring hooks record completion URLs/metadata for UI hand-off.

**Verification**

- [ ] Integration tests for delivery modes (branch/pr/patch) covering push prompts, `--push-to-remote` automation, and failure rollback.
- [ ] Unit tests for branch target validation and push option parsing (including non-interactive exit 10 without `--push-to-remote`).
- [ ] Scenario-driven tests confirming notifications flag propagation to spawned processes (validated via mock notifier hooks).

### M5. Docs, help sync, and manual workflow

**Deliverables**

- Update `specs/Public/CLI.md` (Tasks section) and CLI help text to match the implemented behavior and explicitly note that browser automation remains out of scope for this release.
- Document configuration precedence and fleet/multi-agent flag behavior in the CLI docs and inline help; include clear messaging for disabled cloud automation paths.
- Add `just manual-test-task` covering interactive prompt collection, non-interactive flows with `--prompt-file`, follow-up tasks, delivery variations, `--follow`, and notifications toggles (each step writes per-run logs).

**Verification**

- [ ] `just lint-rust` and `just test-rust` remain green with new coverage.
- [ ] Manual test script runs without intervention following the documented steps; logs stored per run for troubleshooting.
- [ ] Documentation spell-check/link-check passes where applicable.
