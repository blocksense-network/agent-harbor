# R4 — AgentFS Integration in the Task Execution Path

## Overview

This status plan decomposes First Release task **R4** into milestones that make AgentFS the default filesystem isolation provider for macOS and Windows (with Linux parity via FUSE). Each milestone enumerates concrete deliverables and automated verification that must pass before the milestone can be marked complete. All verification items are expressed as automated tests or Justfile targets that run inside the existing Nix dev shell and emit per-test log files.

## Milestones

### M1. Control-plane foundations (1–2 weeks) - COMPLETED

- **Deliverables**
  - Implement an `AgentFsProvider` in `ah-fs-snapshots` that wraps daemon lifecycle management (spawn, handshake, shutdown) and exposes `prepare_writable_workspace`, `snapshot_now`, and `branch_from_snapshot`.
  - Extend provider detection to prefer AgentFS on macOS/Windows when the daemon binary and platform-specific host (FSKit/WinFsp) are available; fall back gracefully when unavailable.
  - Add a reusable `fs-snapshots-test-harness` helper (Rust library crate in `tests/fs-snapshots-test-harness/`) that builds both a callable library and an **external test driver binary**. Because the AgentFS interpose shim is only activated when a process is launched with the shim preloaded, tests must spawn this binary (mirroring the approach in `crates/agentfs-interpose-e2e-tests`) to exercise real filesystem calls. Document this requirement so future tests avoid attempting in-process shim loading.
  - Recreate the legacy provider behavior suite (performance envelopes, concurrent workspace creation, copy-on-write space efficiency, quota enforcement, and error handling) inside the harness’ provider matrix so every provider—Git, ZFS, Btrfs, and AgentFS—is exercised uniformly through the external driver.
  - Wire `ah agent fs status` to call the new provider and surface capability notes, daemon socket location, and host readiness.
- **Verification**
  - [x] `cargo test -p ah-fs-snapshots --test provider_core_behavior_agentfs` (new) spawns the external harness binary so the interpose shim is active, exercises workspace preparation, snapshot creation, and branch cloning, and ensures cleanup tokens remove mounts.
  - [x] `cargo test -p agentfs-daemon --test handshake_smoke` verifies the SSZ handshake, process registration, and basic control requests (`SnapshotCreate`, `BranchCreate`, `BranchBind`).
  - [x] `cargo test -p ah-cli --test agentfs_status_command` uses the harness to assert that `ah agent fs status --json` reports AgentFS as selected when binaries are available.
  - [x] `cargo test -p ah-fs-snapshots --test integration -- test_git_provider_matrix test_zfs_provider_matrix test_btrfs_provider_matrix test_agentfs_provider_matrix` runs the rebuilt provider matrix suite, confirming the external driver performs the restored Ruby scenarios (performance budgets, concurrency, CoW efficiency, quotas, and failure cases) against each provider.

#### Implementation Status

- **Implementation Details**
  - Introduced `AgentFsProvider` control-plane wiring that spawns the daemon via `AgentFsHarness`, manages session state, and exposes `prepare_writable_workspace`, `snapshot_now`, `branch_from_snapshot`, and `mount_readonly` with copy-on-write aware exports. (`crates/ah-fs-snapshots/src/agentfs.rs`)
  - Added the reusable `agentfs-client` crate plus shim integration so both the provider and `agentfs-interpose-shim` share the same SSZ handshake and snapshot export APIs. (`crates/agentfs-client/src/lib.rs`, `crates/agentfs-interpose-shim/src/macos/mod.rs`)
  - Built the external driver and shared harness library in `tests/fs-snapshots-test-harness/`, restored the legacy provider matrix scenarios (performance, concurrency, CoW efficiency, quotas, error handling), and ensured all snapshot providers—including AgentFS—run through the binary so the interpose shim is exercised.
  - Updated provider detection and CLI plumbing so `ah agent fs status` reports AgentFS capability, daemon socket path, and host readiness when the binaries are present. (`crates/ah-cli/src/agent/fs.rs`, `crates/ah-cli/tests/agentfs_status_command.rs`)
  - Implemented lower-filesystem aware snapshot exports in `agentfs-core` so read-only mounts merge upper layer changes with the lower repository instead of copying the entire tree. (`crates/agentfs-core/src/vfs.rs`)
  - Added the `provider_core_behavior_agentfs` integration test that shells out to the harness driver, validates cleanup token idempotency (including readonly export release), and keeps per-run logs under `target/tests`. (`crates/ah-fs-snapshots/tests/provider_core_behavior_agentfs.rs`)
  - Authored the `handshake_smoke` daemon test to launch the production binary, enforce handshake timeouts, drive control-plane requests via `agentfs-client`, and capture the daemon log transcript on failure. (`crates/agentfs-daemon/tests/handshake_smoke.rs`)
  - Created the `docs/AgentFS-Harness-run-book.md` playbook describing build commands, environment variables, and troubleshooting steps for the harness driver and provider matrix.
- **Key Source Files**
  - `crates/ah-fs-snapshots/src/agentfs.rs`
  - `crates/agentfs-client/src/lib.rs`
  - `crates/agentfs-core/src/vfs.rs`
  - `tests/fs-snapshots-test-harness/src/{lib.rs,scenarios.rs,bin/driver.rs}`
  - `crates/ah-cli/src/agent/fs.rs` and `crates/ah-cli/tests/agentfs_status_command.rs`
- **Outstanding Tasks**
  - Ensure cross-platform detection covers Windows parity (tracked for later milestones).

### M2. Workspace preparation in CLI & sandbox tooling (1 week) - COMPLETED

- **Deliverables**
  - Update `prepare_workspace_with_fallback` to call the AgentFS provider first (respecting CLI overrides and working-copy mode) and to reuse or spawn the daemon as needed.
  - Extend `ah agent sandbox` with `--fs-snapshots` (`auto|agentfs|git|zfs|btrfs|disable`) and `--agentfs-socket` flags that reuse existing daemons when provided.
  - Add telemetry and debug logging (via `ah-logging`) that records provider choice, daemon PID, and mount paths.
- **Verification**
  - [x] `cargo test -p ah-cli --test sandbox_workspace_agentfs` exercises `ah agent sandbox --fs-snapshots agentfs` end-to-end, asserting the command exits cleanly, the workspace is isolated, and the daemon is reused when `--agentfs-socket` is provided.
  - [x] `just lint-rust` remains clean after the logging hooks are added (CI gate).
  - [x] New snapshot of CLI help (`cargo test -p ah-cli --test cli_help_snapshots`) verifies the documented flags include AgentFS options.

#### Implementation Status

- **Implementation Details**
  - Updated `prepare_workspace_with_fallback` in `crates/ah-cli/src/sandbox.rs` to prioritize AgentFS provider when available, with support for daemon reuse via `--agentfs-socket` flag. (`crates/ah-cli/src/sandbox.rs`)
  - Added CLI flags `--fs-snapshots` and `--agentfs-socket` to `ah agent sandbox` command with comprehensive argument parsing and validation. (`crates/ah-cli/src/sandbox.rs`)
  - Implemented extensive telemetry and debug logging throughout the workspace preparation flow, recording provider selection, daemon status, and filesystem operations. (`crates/ah-cli/src/sandbox.rs`, `crates/ah-fs-snapshots/src/agentfs.rs`)
  - Created comprehensive integration test `test_sandbox_agentfs_daemon_reuse` that validates end-to-end AgentFS functionality including daemon spawning, socket reuse, filesystem isolation, and overlay persistence. (`crates/ah-cli/tests/sandbox_workspace_agentfs.rs`)
  - Extracted test scripts to separate files for better maintainability: `create-test-files.sh` for generating test filesystem content and `verify-test-files.sh` for validating overlay persistence. (`crates/ah-cli/tests/`)
  - Refactored workspace preparation functions for DRYness by extracting common AgentFS logic into `prepare_agentfs_workspace`. (`crates/ah-fs-snapshots/src/agentfs.rs`)
  - Fixed process binding logic to occur in the interposition shim when processes are spawned, not during workspace preparation. (`crates/agentfs-interpose-shim/src/macos/mod.rs`)
  - Restructured `ah-fs-snapshots-*` crates following the Subcrates-Pattern.md to use monolith + facade architecture. (`crates/ah-fs-snapshots/src/{zfs.rs,btrfs.rs,git.rs}`)
  - Configured platform-specific default features: AgentFS enabled by default on macOS, ZFS/Btrfs/Git enabled on appropriate platforms. (`Cargo.toml`, `crates/ah-cli/Cargo.toml`, `crates/ah-rest-server/Cargo.toml`)
  - Updated CLI documentation in `CLI.md` to include new `--fs-snapshots` and `--agentfs-socket` flags. (`specs/Public/CLI.md`)
  - Documented AgentFS interpose shim usage patterns and environment variables in `README.md`. (`crates/agentfs-interpose-shim/README.md`)
- **Key Source Files**
  - `crates/ah-cli/src/sandbox.rs` - Workspace preparation logic and CLI argument handling
  - `crates/ah-fs-snapshots/src/agentfs.rs` - AgentFS provider implementation with socket reuse
  - `crates/ah-cli/tests/sandbox_workspace_agentfs.rs` - Integration tests
  - `crates/ah-cli/tests/create-test-files.sh` - Test file creation script
  - `crates/ah-cli/tests/verify-test-files.sh` - Test file verification script
  - `crates/agentfs-interpose-shim/src/macos/mod.rs` - Process binding logic
  - `crates/ah-fs-snapshots/src/{zfs.rs,btrfs.rs,git.rs}` - Provider implementations
- **Outstanding Tasks**
  - Fix SSZ transport layer for full AgentFS daemon communication (currently mocked for testing).

### M3. Local task manager integration (2 weeks, platform-parallel)

- **Deliverables**
  - Modify `GenericLocalTaskManager` to request AgentFS workspaces (via the new provider) when working-copy mode is `Auto` or `Snapshots`, binding each launched process to its branch and storing branch IDs in session metadata.
  - Ensure recorder sockets and agent log paths live inside the AgentFS namespace so recordings reflect what the agent sees.
  - Persist AgentFS session metadata (branch IDs, snapshot IDs, daemon socket path) in the local SQLite database for later inspection.
- **Verification**
  - [ ] `cargo test -p ah-core --test agentfs_local_task_manager` launches a mock agent within AgentFS, writes files, checks that host paths remain untouched, and confirms branch metadata is recorded.
  - [ ] `cargo nextest run -p ah-cli --test agent_start_agentfs` (macOS + Windows only) executes `ah agent start --fs-snapshots agentfs` with the mock agent and asserts that branch directories are unique per session and cleaned up on exit.
  - [ ] Database migration smoke test (`cargo test -p ah-local-db --test agentfs_columns`) verifies the new columns exist and round-trip serialization works.

### M4. REST, TUI, and health visibility (1–1.5 weeks)

- **Deliverables**
  - Add `GET /api/v1/system/agentfs` to the REST server returning daemon status, mount paths, and active branches.
  - Include AgentFS metadata in session responses and SSE streams so remote dashboards display branch IDs and snapshot anchors.
  - Surface AgentFS state in the TUI status bar (indicator, errors) and add a detail panel listing branches and storage usage.
  - Instrument `ah health` to ping the AgentFS daemon and report readiness with remediation hints.
- **Verification**
  - [ ] `cargo test -p ah-rest-server --test agentfs_endpoints` spins up the server with the harness, exercises the new endpoint, and confirms agent launches include AgentFS metadata.
  - [ ] `cargo test -p ah-tui --test agentfs_status_indicator` runs the dashboard scenario player against a mocked backend and verifies the indicator renders online/offline states.
  - [ ] `cargo test -p ah-cli --test health_agentfs_probe` ensures `ah health --json` emits pass/fail statuses for the AgentFS check with actionable messages.

### M5. Regression harness & cross-platform acceptance (2 weeks)

- **Deliverables**
  - Refactor existing snapshot regression tests into `tests/agentfs-regressions/` that call an external binary (built from harness helpers) capable of starting FSKit (macOS), WinFsp (Windows), and FUSE (Linux) hosts.
  - Gate tests per platform (`cfg(target_os)`) and ensure logs are routed to `tests/logs/agentfs/*`.
  - Provide `just test-agentfs-regressions` that runs the suite in CI on all platforms and records artifacts (mount tables, branch listings, daemon logs).
  - Add a manual validation script `just manual-test-agentfs` that mounts AgentFS, opens a shell, and prints instructions for human QA; ensure the script’s output references log locations rather than dumping large buffers.
- **Verification**
  - [ ] `just test-agentfs-regressions` executes without regressions on macOS, Windows, and Linux runners, validating isolation, branch divergence, and cleanup.
  - [ ] Regression artifact check (`ci/scripts/assert-agentfs-artifacts.sh`) confirms log files exist and are under size limits; CI fails on missing artifacts.
  - [ ] `just manual-test-agentfs --dry-run` (new flag) runs in CI to verify the script starts/stops cleanly without launching interactive shells.

## Cross-cutting requirements

- All new Justfile targets must run inside the existing dev shell and respect the project’s logging policy (per-test log files).
- Automated tests must clean up daemon sockets, mounts, and temp directories even on failure; use the harness to enforce cleanup in `Drop`.
- Documentation updates to `docs/Component-Architecture.md`, `specs/Public/AgentFS/AgentFS.md`, and CLI help should be performed in the milestone that introduces the corresponding functionality, with `just lint-specs` enforced in CI.
