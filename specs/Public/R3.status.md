---
title: 'R3. Remaining TUI Input Handling — Implementation Plan'
review_status: Draft
---

# Overview

- **Objective:** Complete the outstanding TUI interaction work described in `specs/Public/TUI-PRD.md`, ensuring draft task editing delivers the navigation, autocomplete, auto-save, footer hints, and mouse support promised for the first public release.
- **Scope:** The milestones below break down R3 into focused, verifiable slices that can land independently without regressing the current dashboard. Each slice concludes with automated verification so regressions are caught immediately.
- **Dependencies:** `ah-tui`, `ah-tui-test`, and supporting crates (`ah-core`, `ah-local-db`, `ah-rest-client`) across both local and remote dashboard modes. New tests live beside the existing PRD suites; create new modules when needed to keep coverage organized.

## Milestones

### M1. Textarea Navigation & Scrolling

**Deliverables**

- Complete the up/down wrapping contract for draft textareas, ensuring focus only bubbles once the caret reaches the true start/end (including multi-line selection edge cases).
- Implement smooth scrolling for long drafts: arrow, Page Up/Down, and mouse wheel maintain the caret within the viewport without visual jumps.
- Add regression fixes for Shift+Arrow selections so ranges persist while navigating.

**Verification**

- Extend `crates/ah-tui/tests/prd_input_tests.rs` with cases for caret wrapping, Shift+Arrow selection, Page Up/Down, and scroll-wheel events using the deterministic runner.
- Add focused assertions that inspect `TaskEntryViewModel` state after each input operation to prove the caret, scroll offsets, and selection range update as expected at multiple terminal heights.

### M2. Autocomplete UX & Ghost Text

**Deliverables**

- Expand `InlineAutocomplete` to cache results, display ghost text for the active suggestion, and merge async refreshes without flicker.
- Trigger menus immediately on `/` and `@`, carrying over the selected item when refreshed.
- Support Right Arrow quick-pick, Tab/Enter acceptance, Esc dismissal, and mouse wheel/click selection parity.

**Verification**

- Add unit tests for `InlineAutocomplete` covering caching, refresh churn, ghost text rendering, and new key bindings.
- Extend PRD-focused tests to drive the autocomplete through slash/at triggers, async refresh, mouse selection, and ghost overlay usage, asserting against the resulting view model state instead of snapshot diffs.

### M3. Draft Auto-Save State Machine

**Deliverables**

- Replace the placeholder timer with a debounced, generation-aware state machine that drives `Unsaved → Saving → Saved/Error` transitions.
- Surface state indicators in the draft card corner and emit error banners with retry shortcuts when persistence fails (local DB + REST).
- Coalesce duplicate saves in `ah-local-db` and REST flows, ensuring zero data loss if focus changes during async persistence.

**Verification**

- Add unit tests for the new state machine (generation handling, invalidation, error retry).
- Introduce integration tests in `ah-core` and `ah-local-db` verifying deduplicated saves and failure propagation (mock REST client for remote mode).
- Expand view model tests that execute save flows and confirm state transitions (`Unsaved`, `Saving…`, `Saved`, `Error`) occur without relying on rendered output comparisons.

### M4. Footer & Shortcut Context

**Deliverables**

- Centralize footer shortcut computation so pluralization (“Agent(s)”) and modal state changes update instantly.
- Add mouse hint segments when pointer activity is detected (scroll/click guidance).
- Ensure draft textarea focus shows `Enter Launch Agent(s) • Shift+Enter New Line • Tab Next Field`, and other states follow the PRD matrix.

**Verification**

- Add footer-specific regression tests (new `footer_shortcut_tests.rs`) confirming the computed shortcut strings for each focus state.
- Enhance existing PRD tests to drive footer updates (e.g., changing model counts, opening modals) and assert the view model’s footer data matches the PRD matrix.

### M5. Mouse Interaction Enhancements

**Deliverables**

- Support click-to-caret positioning with padding-aware math, selection drag, and wheel scrolling for both textarea and modal lists.
- Provide accessibility fallbacks when mouse support is disabled via settings.
- Register hit regions for +/- count controls inside the model selector modal.

**Verification**

- Extend scenario tests to inject `MouseAction` events, asserting caret placement, drag selection, and scroll behavior.
- Add unit tests for hit registration and padding calculations.

### M6. Mouse Click Selection Semantics

**Deliverables**

- Single click positions the caret at the precise location of the pointer, honoring padding and wide glyphs.
- Double click selects the word under the caret, using the same token boundaries as keyboard shortcuts.
- Triple click selects the entire logical line; a fourth rapid click expands the selection to the whole textarea.
- Respect timing thresholds so slow successive clicks behave as single clicks.

**Verification**

- Add focused tests that synthesize click, double-click, triple-click, and quadruple-click events and assert the resulting caret and selection ranges within `TaskEntryViewModel`.
- Extend the PRD input suite to cover double/triple-click behavior at different cursor positions, ensuring selections collapse correctly when the user types afterwards.

### M7. Documentation & Manual Tooling

**Deliverables**

- Update `specs/Public/TUI-PRD.md` implementation notes with the finalized keyboard/mouse matrix, auto-save indicators, and troubleshooting pointers.
- Refresh the dashboard manual recipe (`just manual-test-tui`) with a scripted walkthrough that validates the new interactions; include log capture per the testing guidelines.
- Create a concise operator guide in `docs/Component-Architecture.md` referencing the new manual script and diagnostics.

**Verification**

- Run `just lint-specs` and `just lint-readme` (if README touches occur) to keep docs lint-clean.
- Add a smoke test (`just test-manual-tui-smoke`) that executes the scripted walkthrough headlessly and confirms log creation, wired into `just test-rust`.

## Outstanding Tasks

- After each milestone lands, append an **Implementation Status** subsection summarizing key source files, outstanding follow-ups, and checked verification boxes (mirroring `MVP.status.md`).
- Track parallel work carefully: milestones M1–M3 touch shared modules, so prefer short-lived branches or feature flags while the state machine stabilizes.
- Ensure CI coverage is expanded gradually; avoid flipping existing PRD suites to fail-on-missing-behavior until the relevant milestone lands.
