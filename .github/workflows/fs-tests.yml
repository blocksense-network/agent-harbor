# Copyright 2025 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

name: Filesystem tests

on:
  # Enable option to manually run the action:
  workflow_dispatch:

  # Run on PRs that target `main` it:
  pull_request:
    branches:
      - main

  # Run the pipeline for each PR part of merge queues as well
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  fuse-harness:
    name: FUSE harness
    runs-on: [self-hosted, nixos, x86-64-v3, microvm]

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Build AgentFS FUSE binaries
        run: |
          cargo build -p agentfs-fuse-host --features fuse
          cargo build -p agentfs-control-cli

      - name: Run mount cycle harness
        run: just test-fuse-mount-cycle
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run mount failure harness
        run: just test-fuse-mount-failures
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run concurrent mount harness
        run: just test-fuse-mount-concurrent
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run basic ops harness
        run: just test-fuse-basic-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run negative ops harness
        run: just test-fuse-negative-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run overlay ops harness
        run: just test-fuse-overlay-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run control-plane harness
        run: just test-fuse-control-plane
        env:
          SKIP_FUSE_BUILD: 1
          SKIP_CONTROL_CLI_BUILD: 1

  pjdfstest:
    name: pjdfstest suite
    needs: fuse-harness
    runs-on: [self-hosted, nixos, x86-64-v3, microvm]

    steps:
      - name: Test passwordless `sudo`
        run: sudo true

      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Build FUSE test binaries
        run: just build-fuse-test-binaries

      - name: Run full pjdfstest suite
        run: SKIP_FUSE_BUILD=1 just test-pjdfstest-full

      - name: Capture pjdfstest logs path
        run: |
          LOG_DIR=$(ls -td logs/pjdfstest-full-* 2>/dev/null | head -n 1 || true)
          if [ -z "$LOG_DIR" ]; then
            echo "pjdfstest log directory not found" >&2
            exit 1
          fi
          echo "PJDFS_LOG_DIR=$LOG_DIR" >> "$GITHUB_ENV"

      - name: Upload pjdfstest logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pjdfstest-full
          path: ${{ env.PJDFS_LOG_DIR }}
