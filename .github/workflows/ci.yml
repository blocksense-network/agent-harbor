# Copyright 2025 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

# CI Policy: Always use just targets in CI workflows
# This ensures developers can run the exact same commands locally that CI uses,
# maintaining consistency and making local development match CI behavior.
#
# To run CI commands locally:
#   just fmt-rust-check    # Check code formatting
#   just lint-rust         # Run clippy linting
#   just check             # Check compilation
#   just build-cgroup-tests # Build test binaries
#   just test-rust-verbose # Run tests with verbose output
#   just build-sbx-helper-release # Build release binary
#   just build-agentfs-rust-libs # Build AgentFS Rust libraries (macOS only)
#   just test-agent-harbor   # Build and validate macOS AgentHarbor app (macOS only)

name: CI

on:
  push:
    branches: [main, linux-sandbox]
  pull_request:
    branches: [main, linux-sandbox]

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CHECK_MERMAID: ${{ vars.CHECK_MERMAID }}

jobs:
  lint:
    runs-on: [self-hosted, nixos, x86-64-v3]

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Run Lint
        run: nix develop -c pre-commit run --all-files

  build-and-cache-devshell:
    strategy:
      matrix:
        include:
          - name: x86_64-linux (NixOS, self-hosted)
            runner: [self-hosted, nixos, x86-64-v3]
            system: x86_64-linux
          - name: aarch64-darwin (macOS, GitHub-hosted)
            runner: macos-latest
            system: aarch64-darwin

    name: Build devshell | ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: nix run nixpkgs#nix-fast-build -L -- --no-nom --skip-cached --flake .#devShells.${{ matrix.system }}.default

  test:
    strategy:
      matrix:
        include:
          - name: x86_64-linux (NixOS, self-hosted)
            runner: [self-hosted, nixos, x86-64-v3, microvm]
            allowedToFail: false
          # - name: aarch64-darwin (macOS, GitHub-hosted)
          #   runner: macos-latest
          #   allowedToFail: true

    name: Rust tests | ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    continue-on-error: ${{ matrix.allowedToFail }}

    steps:
      - name: Test user namespace availability
        run: unshare -U true && echo "✅ userns OK" || echo "❌ userns blocked"

      - name: Test passwordless `sudo` availability
        run: sudo true && echo "✅ sudo OK" || echo "❌ sudo blocked"

      - name: Investigate sudo
        run: |
          set -x
          ls -l "$(command -v sudo)"
          id
          whoami
          sudo whoami || true
          grep -E 'NoNewPrivs|CapEff|CapBnd' /proc/self/status || true
          mount | grep " on /run " || true
          mount | grep " on /run/wrappers" || true
          grep -E '^(NoNewPrivs|CapEff|CapBnd|Seccomp)' /proc/self/status
          echo "-- uid/gid maps (user namespace check) --"
          cat /proc/self/uid_map /proc/self/gid_map 2>/dev/null || true

      - name: Test passwordless `sudo` availability
        run: sudo true && echo "✅ sudo OK" || echo "❌ sudo blocked"

      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Run sandbox-fs tests to fail-fast check the CI runner permissions
        run: |
          cargo test -p sandbox-fs

      - name: Check compilation
        run: just check

      - name: Build sandbox helper binary
        run: just build-sbx-helper-release

      - name: Build cgroup enforcement test binaries
        run: just build-cgroup-tests

      # - run: sudo just create-test-filesystems
      #
      # - run: sudo just start-ah-fs-snapshots-daemon

      - name: Run tests
        run: just test-rust-verbose

  fuse-harness:
    name: FUSE harness
    runs-on: [self-hosted, nixos, x86-64-v3]
    env:
      AGENTFS_FUSE_ALLOW_OTHER: 0

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Ensure FUSE prerequisites (sudo + /dev/fuse)
        run: |
          set -euo pipefail
          sudo_ok=0
          if command -v sudo >/dev/null 2>&1 && sudo true; then
            sudo_ok=1
          else
            echo "sudo not available; will skip fuse harness" >&2
          fi
          if [ "$sudo_ok" -eq 1 ]; then
            if [ ! -e /dev/fuse ] && command -v modprobe >/dev/null 2>&1; then
              sudo modprobe fuse || true
            fi
            if [ ! -e /dev/fuse ] && command -v mknod >/dev/null 2>&1; then
              sudo mknod /dev/fuse c 10 229 || true
              sudo chmod 666 /dev/fuse || true
            fi
          fi
          if [ ! -e /dev/fuse ]; then
            echo "FUSE_SKIP=1" >> "$GITHUB_ENV"
            echo "Skipping fuse harness: /dev/fuse unavailable on this runner" >&2
            exit 0
          fi

      - name: Build AgentFS FUSE binaries
        if: env.FUSE_SKIP != '1'
        run: |
          cargo build -p agentfs-fuse-host --features fuse
          cargo build -p agentfs-control-cli

      - name: Run FUSE verification suites (F1–F7)
        if: env.FUSE_SKIP != '1'
        env:
          SKIP_FUSE_BUILD: 1
        run: |
          set -euo pipefail
          MNT="/tmp/agentfs-ci-basic"
          rm -rf "$MNT"
          just mount-fuse "$MNT"
          just test-fuse-basic "$MNT"
          just umount-fuse "$MNT"
          just test-fuse-basic-ops
          just test-fuse-negative-ops
          just test-fuse-control-plane
          just test-fuse-overlay-ops
          just test-fuse-mount-cycle
          just test-fuse-mount-failures
          just test-fuse-mount-concurrent
          just test-fuse-stress
          just test-pjdfstest-full

      - name: Run F8 harnesses (xattrs/mknod/mount options/advanced I/O)
        if: env.FUSE_SKIP != '1'
        env:
          SKIP_FUSE_BUILD: 1
        run: |
          set -euo pipefail
          just test-fuse-xattrs
          just test-fuse-mknod
          just test-fuse-mount-options
          just test-fuse-advanced-io

      - name: Run F10 security harnesses
        if: env.FUSE_SKIP != '1'
        env:
          SKIP_FUSE_BUILD: 1
        run: |
          set -euo pipefail
          just test-fuse-security-permissions
          just test-fuse-security-privileges
          just test-fuse-security-input
          just test-fuse-security-sandbox
          just test-fuse-security-robustness

      - name: Run FUSE performance harness
        if: env.FUSE_SKIP != '1'
        env:
          SKIP_FUSE_BUILD: 1
        run: just test-fuse-performance
        continue-on-error: true

      - name: Run basic ops harness
        run: just test-fuse-basic-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run negative ops harness
        run: just test-fuse-negative-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run overlay ops harness
        run: just test-fuse-overlay-ops
        env:
          SKIP_FUSE_BUILD: 1

      - name: Run control-plane harness
        run: just test-fuse-control-plane
        env:
          SKIP_FUSE_BUILD: 1
          SKIP_CONTROL_CLI_BUILD: 1

  webui:
    runs-on: [self-hosted, nixos, x86-64-v3]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Install JS deps
        run: yarn install

      - name: Lint WebUI code
        run: just webui-lint

      - name: Type check WebUI code
        run: just webui-type-check

      - name: Build WebUI app
        run: just webui-build

      - name: Build mock server
        run: just webui-build-mock

      # - name: Install Playwright browsers
      #   run: just webui-install-browsers

      # TODO: Once tests are stable bring them back
      # - name: Run Playwright tests
      #   run: just webui-test
      #   env:
      #     BASE_URL: http://localhost:3000

  pjdfstest:
    name: pjdfstest suite
    needs: fuse-harness
    runs-on: [self-hosted, nixos, x86-64-v3]

    steps:
      - name: Test passwordless `sudo`
        run: |
          if ! sudo true; then
            echo "FUSE_SKIP=1" >> "$GITHUB_ENV"
            echo "Skipping pjdfstest: sudo unavailable" >&2
            exit 0
          fi

      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - name: Build FUSE test binaries
        if: env.FUSE_SKIP != '1'
        run: just build-fuse-test-binaries

      - name: Run full pjdfstest suite
        if: env.FUSE_SKIP != '1'
        run: SKIP_FUSE_BUILD=1 just test-pjdfstest-full

      - name: Capture pjdfstest logs path
        if: env.FUSE_SKIP != '1'
        run: |
          LOG_DIR=$(ls -td logs/pjdfstest-full-* 2>/dev/null | head -n 1 || true)
          if [ -z "$LOG_DIR" ]; then
            echo "pjdfstest log directory not found" >&2
            exit 1
          fi
          echo "PJDFS_LOG_DIR=$LOG_DIR" >> "$GITHUB_ENV"

      - name: Upload pjdfstest logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pjdfstest-full
          path: ${{ env.PJDFS_LOG_DIR }}

  deploy-sites:
    name: Deploy sites ${{ matrix.label }}
    strategy:
      # Ensure we deploy all sites that build even if one fails
      fail-fast: false
      matrix:
        include:
          - label: Docs site
            cf_project: agent-harbor-docs
            build_command: yarn workspace site build
            dist_path: docs/site/out
          - label: WebUI
            cf_project: agent-harbor-webui
            build_command: just webui-build
            dist_path: webui/app/dist
    uses: ./.github/workflows/deploy-site.yml
    permissions:
      contents: read
      pull-requests: write
    secrets:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    with:
      label: ${{ matrix.label }}
      cf_project: ${{ matrix.cf_project }}
      build_command: ${{ matrix.build_command }}
      dist_path: ${{ matrix.dist_path }}
