# Copyright 2025 Schelling Point Labs Inc
# SPDX-License-Identifier: AGPL-3.0-only

# CI Policy: Always use just targets in CI workflows
# This ensures developers can run the exact same commands locally that CI uses,
# maintaining consistency and making local development match CI behavior.
#
# To run CI commands locally:
#   just fmt-rust-check    # Check code formatting
#   just lint-rust         # Run clippy linting
#   just check             # Check compilation
#   just build-cgroup-tests # Build test binaries
#   just test-rust-verbose # Run tests with verbose output
#   just build-sbx-helper-release # Build release binary
#   just build-agentfs-rust-libs # Build AgentFS Rust libraries (macOS only)
#   just test-agent-harbor   # Build and validate macOS AgentHarbor app (macOS only)

name: CI

on:
  # Enable option to manually run the action:
  workflow_dispatch:

  # Run on PRs that target `main`:
  push:
  pull_request:

  # Run the pipeline for each PR part of merge queues as well
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CHECK_MERMAID: ${{ vars.CHECK_MERMAID }}

jobs:
  test:
    strategy:
      matrix:
        include:
          - name: x86_64-linux (NixOS, self-hosted)
            runner: [self-hosted, nixos, x86-64-v3, microvm]
            allowedToFail: false

    name: Rust tests | ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    continue-on-error: ${{ matrix.allowedToFail }}

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Install Nix
        uses: metacraft-labs/nixos-modules/.github/install-nix@main
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          cachix-cache: ${{ vars.CACHIX_CACHE }}
          trusted-public-keys: ${{ vars.TRUSTED_PUBLIC_KEYS }}
          substituters: ${{ vars.SUBSTITUTERS }}

      - name: Build & activate the Nix Dev Shell
        run: |
          direnv allow .
          direnv export gha > "$GITHUB_ENV"

      - run: |
          script -r my-zellij-2 sh -c 'zellij attach --create-background bg-session; zellij list-sessions'

      - run: zellij && echo "zellij ok" || echo "Zellij failed"
      - run: |
          export SHELL=$(nix build --json nixpkgs#bashInteractive | jq -r '.[0].outputs.out')
          script -r "zellij" && echo "script + zellij ok" || echo "script + Zellij failed"

      - run: tmux -L ci new-session -d -s mysession "run-some-command"
      - run: tmux -L ci send-keys -t mysession "echo 'hello from tmux'" C-m
      - run: tmux -L ci capture-pane -pt mysession
      - run: tmux -L ci kill-session -t mysession
