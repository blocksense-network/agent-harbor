#!/usr/bin/env bash
# Install Nix package manager
# See: https://nixos.org/download.html

set -euo pipefail

# Check if we're in test mode
if [ "${TEST_MODE:-}" = "1" ]; then
    echo "TEST: Installing Nix package manager..."
    echo "TEST: Updating package lists..."
    sleep 0.1
    echo "TEST: Installing dependencies (curl, sudo, gnupg2, xz-utils)..."
    sleep 0.1
    echo "TEST: Downloading Nix installer from https://nixos.org/nix/install"
    echo "TEST: Running installer with --daemon --yes flags..."
    sleep 0.2
    echo "TEST: Setting up Nix profile for login shells..."
    echo "TEST: Creating /etc/profile.d/nix-path.sh"
    sleep 0.1
    echo "TEST: Creating Nix configuration directory /etc/nix"
    echo "TEST: Writing nix.conf with experimental features enabled"
    sleep 0.1
    echo "TEST: Nix installation completed successfully!"
    echo "TEST: Nix version: nix (Nix) 2.18.1"
    echo "TEST: Available commands: nix, nix-build, nix-shell, nix-env"
    exit 0
fi

echo "Installing Nix package manager..."

# Check if Nix is already installed
if command -v nix >/dev/null 2>&1; then
    echo "Nix is already installed: $(nix --version)"
    exit 0
fi

# Detect the operating system
OS="$(uname -s)"

case "$OS" in
    Linux*)
        echo "Installing Nix on Linux..."

        # Update package lists and install dependencies
        if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y --no-install-recommends \
                curl \
                sudo \
                gnupg2 \
                xz-utils
        elif command -v yum >/dev/null 2>&1; then
            yum update -y
            yum install -y curl sudo gnupg2 xz
        elif command -v pacman >/dev/null 2>&1; then
            pacman -Sy --noconfirm curl sudo gnupg xz
        else
            echo "Warning: Unknown package manager, attempting to continue..."
        fi
        ;;
    Darwin*)
        echo "Installing Nix on macOS..."
        # macOS typically has curl built-in, but we may need to install xz
        if command -v brew >/dev/null 2>&1; then
            brew install xz || true  # Don't fail if already installed
        fi
        ;;
    *)
        echo "ERROR: Unsupported operating system: $OS"
        exit 1
        ;;
esac

# Download and run the Nix installer
echo "Downloading Nix installer..."
if curl -L https://nixos.org/nix/install | sh -s -- --daemon --yes; then
    echo "Nix installer completed successfully"
else
    echo "Warning: Nix installer may have encountered issues"
    echo "Checking if Nix was still installed..."
fi

# Set up Nix profile for login shells
echo "Setting up Nix profile..."
printf '%s\n' \
  '# Nix profile (exported for login shells)' \
  'if [ -d /nix/var/nix/profiles/default/bin ]; then' \
  '  export PATH=/nix/var/nix/profiles/default/bin:$PATH' \
  'fi' \
  'if [ -d /root/.nix-profile/bin ]; then' \
  '  export PATH=/root/.nix-profile/bin:$PATH' \
  'fi' \
  > /etc/profile.d/nix-path.sh \
 && chmod +x /etc/profile.d/nix-path.sh || echo "Warning: Could not set up system-wide Nix profile (permission denied)"

# Create Nix configuration
echo "Configuring Nix..."
if mkdir -p /etc/nix 2>/dev/null; then
    cat <<EOF > /etc/nix/nix.conf
experimental-features = flakes nix-command
EOF
else
    echo "Warning: Could not create system-wide Nix configuration (permission denied)"
fi

echo "Nix installation completed successfully!"

# Verify installation and set up post-install script
echo "Setting up Nix environment..."

# Try to source the appropriate Nix profile
if [ -f /etc/profile.d/nix-path.sh ]; then
    echo "Using system-wide Nix profile"
    source /etc/profile.d/nix-path.sh
    PROFILE_SOURCE="/etc/profile.d/nix-path.sh"
elif [ -f '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    echo "Using Nix's built-in daemon profile"
    source '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
    PROFILE_SOURCE="/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
else
    echo "Warning: Could not find Nix profile to source"
    PROFILE_SOURCE=""
fi

# If POST_INSTALL_SCRIPT is set, append the appropriate source command
if [ -n "${POST_INSTALL_SCRIPT:-}" ] && [ -n "$PROFILE_SOURCE" ]; then
    echo "# Source Nix profile for environment setup" >> "$POST_INSTALL_SCRIPT"
    echo "if [ -f $PROFILE_SOURCE ]; then" >> "$POST_INSTALL_SCRIPT"
    echo "    source $PROFILE_SOURCE" >> "$POST_INSTALL_SCRIPT"
    echo "fi" >> "$POST_INSTALL_SCRIPT"
    echo "" >> "$POST_INSTALL_SCRIPT"
fi

if command -v nix >/dev/null 2>&1; then
    echo "Nix version: $(nix --version)"
    echo "Available commands: nix, nix-build, nix-shell, nix-env"
else
    echo "Warning: Nix installation may require a shell restart to be available in PATH"
fi
